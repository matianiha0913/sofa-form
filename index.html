<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Matiani | سیستم مدیریت سفارش</title>
<style>
body{font-family:Tahoma,sans-serif;margin:0;padding:0;background:#fff;color:#000;}
h1,h2,h3{text-align:center;}
h1 span{color:#0f0;}
.container{max-width:950px;margin:20px auto;background:#fff;border-radius:10px;border:2px solid #000;padding:20px;}
label{display:block;font-weight:bold;margin-top:10px;}
input,textarea{width:96%;padding:6px;border-radius:5px;border:1px solid #000;margin-top:4px;}
textarea{min-height:60px;}
.btn{background:#0f0;color:#000;padding:8px 14px;margin:5px;border:none;border-radius:5px;cursor:pointer;font-weight:bold;}
.btn:hover{background:#0c0;}
.section{border:2px solid #000;border-radius:8px;margin-top:15px;padding:10px;background:#f9f9f9;}
.output{border:2px solid #000;border-radius:8px;margin-top:15px;padding:10px;background:#fff;color:#000;display:none;}
.hidden{display:none;}
@media(max-width:600px){.container{padding:10px}input,textarea{width:100%;}}
</style>
</head>
<body>

<!-- صفحه ورود امن -->
<div class="container" id="loginDiv">
<h1>🛋 <span>Matiani</span> | ورود به سیستم</h1>
<label>کد ورود</label>
<input type="text" id="loginCode" placeholder="کد یک‌بار مصرف خود را وارد کنید">
<button class="btn" onclick="login()">ورود</button>
</div>

<!-- فرم اصلی سفارش -->
<div class="container hidden" id="mainDiv">

<label>شماره فاکتور</label><input id="invoiceNo" placeholder="مثلاً 1001">
<label>نام مشتری</label><input id="customer">
<label>مدل مبل</label><input id="model">
<label>تاریخ تحویل</label><input id="delDate" placeholder="YYYY-MM-DD">

<div class="section" id="paintSection">
<h3>۱. رنگ‌کاری</h3>
<div class="paint-item"><input placeholder="رنگ کار" class="paintColor"></div>
<button class="btn" onclick="addField('paint')">➕</button>
</div>

<div class="section" id="fabSection">
<h3>۲. خیاطی</h3>
<div class="fab-item"><input placeholder="کد/رنگ پارچه" class="fabColor"></div>
<button class="btn" onclick="addField('fab')">➕</button>
</div>

<div class="section" id="carpSection">
<h3>۳. نجاری</h3>
<div class="carp-item"><input placeholder="مدل مبل" class="carpModel"></div>
<button class="btn" onclick="addField('carp')">➕</button>
</div>

<div class="section" id="upSection">
<h3>۴. روی‌کوبی</h3>
<div class="up-item"><input placeholder="توضیحات" class="upNote"></div>
<button class="btn" onclick="addField('up')">➕</button>
</div>

<div class="section">
<h3>۵. تحویل کالا</h3>
<textarea id="delNote" placeholder="آدرس و توضیحات تحویل"></textarea>
</div>

<div style="text-align:center;">
<button class="btn" onclick="saveOrder()">💾 ذخیره سفارش</button>
<button class="btn" onclick="toggleOrders()">📋 نمایش/جستجو سفارش‌ها</button>
<input type="text" id="searchInput" placeholder="جستجو: شماره فاکتور، نام، مدل" oninput="renderOrders()">
</div>

<div id="orderList" class="section hidden"></div>
<div id="output" class="output"></div>
</div>

<script>
const BACKEND_URL='https://YOUR_VERCEL_APP/api/saveOrder';
let orders=[];

async function login(){
  const code=document.getElementById('loginCode').value.trim();
  if(!code) return alert('لطفاً کد را وارد کنید');
  try{
    const res=await fetch('https://YOUR_VERCEL_APP/api/login',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({code})
    });
    const data=await res.json();
    if(data.ok){
      document.getElementById('loginDiv').classList.add('hidden');
      document.getElementById('mainDiv').classList.remove('hidden');
      loadOrders();
    }else alert('کد نامعتبر است');
  }catch(e){alert('خطا در اتصال به سرور');}
}

async function loadOrders(){
  try{
    const res=await fetch(BACKEND_URL);
    if(res.ok){orders=await res.json();localStorage.setItem('orders',JSON.stringify(orders));return;}
  }catch{}
  orders=JSON.parse(localStorage.getItem('orders')||"[]");
}

function addField(type){
  let section=document.getElementById(type+'Section'); let html='';
  if(type==='paint') html=`<div class='paint-item'><input placeholder='رنگ کار' class='paintColor'></div>`;
  if(type==='fab') html=`<div class='fab-item'><input placeholder='کد/رنگ پارچه' class='fabColor'></div>`;
  if(type==='carp') html=`<div class='carp-item'><input placeholder='مدل مبل' class='carpModel'></div>`;
  if(type==='up') html=`<div class='up-item'><input placeholder='توضیحات' class='upNote'></div>`;
  section.insertAdjacentHTML('beforeend',html);
}

function collect(selector,field){return [...document.querySelectorAll(selector)].map(el=>el.querySelector('input.'+field)?.value.trim()).filter(Boolean);}
function val(id){return document.getElementById(id).value.trim();}

async function saveOrder(){
  let order={
    invoiceNo:val('invoiceNo'),
    customer:val('customer'),
    model:val('model'),
    delDate:val('delDate'),
    delNote:val('delNote'),
    paint:collect('.paint-item','paintColor'),
    fab:collect('.fab-item','fabColor'),
    carp:collect('.carp-item','carpModel'),
    up:collect('.up-item','upNote')
  };
  orders.push(order);
  localStorage.setItem('orders',JSON.stringify(orders));
  clearForm();
  await pushToGithub(order);
  renderOrders();
  alert('✅ سفارش ذخیره شد');
}

function clearForm(){document.querySelectorAll('input,textarea').forEach(el=>{if(el.type!=='file')el.value='';});document.getElementById('invoiceNo').focus();}
function toggleOrders(){document.getElementById('orderList').classList.toggle('hidden');renderOrders();}
function formatArray(arr){return arr.join('<br>');}

function renderOrders(){
  let listDiv=document.getElementById('orderList');
  let search=document.getElementById('searchInput').value.toLowerCase();
  let filtered=orders.filter(o=>o.invoiceNo.toLowerCase().includes(search) || o.customer.toLowerCase().includes(search) || o.model.toLowerCase().includes(search));
  if(filtered.length===0){listDiv.innerHTML='<p>هیچ سفارشی یافت نشد.</p>';return;}
  listDiv.innerHTML=filtered.map((o,i)=>`
  <div style='border:1px solid #000;padding:8px;margin-bottom:8px;'>
  <b>#${o.invoiceNo} | ${o.customer}</b> | مدل: ${o.model} | تاریخ تحویل: ${o.delDate}
  <div style='margin-top:6px;'>
  <button class='btn' onclick="showSection(${i},'paint')">🎨 رنگ‌کاری</button>
  <button class='btn' onclick="showSection(${i},'fab')">🧵 خیاطی</button>
  <button class='btn' onclick="showSection(${i},'carp')">🪓 نجاری</button>
  <button class='btn' onclick="showSection(${i},'up')">🛠 روی‌کوبی</button>
  <button class='btn' onclick="showSection(${i},'del')">🚚 تحویل کالا</button>
  </div></div>`).join('');
}

function showSection(i,type){
  const o=orders[i];let html='';
  if(type==='paint') html=`<h3>رنگ‌کاری</h3>${formatArray(o.paint)}`;
  if(type==='fab') html=`<h3>خیاطی</h3>${formatArray(o.fab)}`;
  if(type==='carp') html=`<h3>نجاری</h3>${formatArray(o.carp)}`;
  if(type==='up') html=`<h3>روی‌کوبی</h3>${formatArray(o.up)}`;
  if(type==='del') html=`<h3>تحویل کالا</h3>
  <b>شماره فاکتور:</b> ${o.invoiceNo}<br>
  <b>نام مشتری:</b> ${o.customer}<br>
  <b>مدل:</b> ${o.model}<br>
  <b>تاریخ تحویل:</b> ${o.delDate}<br>
  <b>رنگ‌کاری:</b> ${formatArray(o.paint)}<br>
  <b>خیاطی:</b> ${formatArray(o.fab)}<br>
  <b>نجاری:</b> ${formatArray(o.carp)}<br>
  <b>روی‌کوبی:</b> ${formatArray(o.up)}<br>
  <b>توضیحات تحویل:</b> ${o.delNote}<br>`;
  const out=document.getElementById('output');
  out.innerHTML=`${html}<div style='text-align:center;margin-top:8px;'><button class='btn' onclick='printSection()'>🖨 چاپ</button></div>`;
  out.style.display='block';window.scrollTo(0,document.body.scrollHeight);
}

function printSection(){const content=document.getElementById('output').innerHTML;const newWin=window.open('','_blank');newWin.document.write('<html><head><title>چاپ</title></head><body>'+content+'</body></html>');newWin.document.close();newWin.print();}

async function pushToGithub(order){
  try{
    const res=await fetch(BACKEND_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(order)});
    const data=await res.json();
    if(data.ok){orders=data.orders; localStorage.setItem('orders',JSON.stringify(orders)); renderOrders(); return true;}
    else return false;
  }catch(e){console.warn('pushToGithub failed',e); return false;}
}
</script>
</body>
</html>
