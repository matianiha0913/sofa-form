<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Matiani | Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´</title>
<style>
body{font-family:Tahoma,sans-serif;margin:0;padding:0;background:#fff;color:#000;}
h1,h2,h3{text-align:center;}
h1 span{color:#0f0;}
.container{max-width:950px;margin:20px auto;background:#fff;border-radius:10px;border:2px solid #000;padding:20px;}
label{display:block;font-weight:bold;margin-top:10px;}
input,textarea{width:96%;padding:6px;border-radius:5px;border:1px solid #000;margin-top:4px;}
textarea{min-height:60px;}
.btn{background:#0f0;color:#000;padding:8px 14px;margin:5px;border:none;border-radius:5px;cursor:pointer;font-weight:bold;}
.btn:hover{background:#0c0;}
.section{border:2px solid #000;border-radius:8px;margin-top:15px;padding:10px;background:#f9f9f9;}
.output{border:2px solid #000;border-radius:8px;margin-top:15px;padding:10px;background:#fff;color:#000;display:none;}
.hidden{display:none;}
@media(max-width:600px){.container{padding:10px}input,textarea{width:100%;}}
</style>
</head>
<body>

<!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ø§Ù…Ù† -->
<div class="container" id="loginDiv">
<h1>ğŸ›‹ <span>Matiani</span> | ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</h1>
<label>Ú©Ø¯ ÙˆØ±ÙˆØ¯</label>
<input type="text" id="loginCode" placeholder="Ú©Ø¯ ÛŒÚ©â€ŒØ¨Ø§Ø± Ù…ØµØ±Ù Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
<button class="btn" onclick="login()">ÙˆØ±ÙˆØ¯</button>
</div>

<!-- ÙØ±Ù… Ø§ØµÙ„ÛŒ Ø³ÙØ§Ø±Ø´ -->
<div class="container hidden" id="mainDiv">

<label>Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±</label><input id="invoiceNo" placeholder="Ù…Ø«Ù„Ø§Ù‹ 1001">
<label>Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ</label><input id="customer">
<label>Ù…Ø¯Ù„ Ù…Ø¨Ù„</label><input id="model">
<label>ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„</label><input id="delDate" placeholder="YYYY-MM-DD">

<div class="section" id="paintSection">
<h3>Û±. Ø±Ù†Ú¯â€ŒÚ©Ø§Ø±ÛŒ</h3>
<div class="paint-item"><input placeholder="Ø±Ù†Ú¯ Ú©Ø§Ø±" class="paintColor"></div>
<button class="btn" onclick="addField('paint')">â•</button>
</div>

<div class="section" id="fabSection">
<h3>Û². Ø®ÛŒØ§Ø·ÛŒ</h3>
<div class="fab-item"><input placeholder="Ú©Ø¯/Ø±Ù†Ú¯ Ù¾Ø§Ø±Ú†Ù‡" class="fabColor"></div>
<button class="btn" onclick="addField('fab')">â•</button>
</div>

<div class="section" id="carpSection">
<h3>Û³. Ù†Ø¬Ø§Ø±ÛŒ</h3>
<div class="carp-item"><input placeholder="Ù…Ø¯Ù„ Ù…Ø¨Ù„" class="carpModel"></div>
<button class="btn" onclick="addField('carp')">â•</button>
</div>

<div class="section" id="upSection">
<h3>Û´. Ø±ÙˆÛŒâ€ŒÚ©ÙˆØ¨ÛŒ</h3>
<div class="up-item"><input placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª" class="upNote"></div>
<button class="btn" onclick="addField('up')">â•</button>
</div>

<div class="section">
<h3>Ûµ. ØªØ­ÙˆÛŒÙ„ Ú©Ø§Ù„Ø§</h3>
<textarea id="delNote" placeholder="Ø¢Ø¯Ø±Ø³ Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª ØªØ­ÙˆÛŒÙ„"></textarea>
</div>

<div style="text-align:center;">
<button class="btn" onclick="saveOrder()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø³ÙØ§Ø±Ø´</button>
<button class="btn" onclick="toggleOrders()">ğŸ“‹ Ù†Ù…Ø§ÛŒØ´/Ø¬Ø³ØªØ¬Ùˆ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</button>
<input type="text" id="searchInput" placeholder="Ø¬Ø³ØªØ¬Ùˆ: Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±ØŒ Ù†Ø§Ù…ØŒ Ù…Ø¯Ù„" oninput="renderOrders()">
</div>

<div id="orderList" class="section hidden"></div>
<div id="output" class="output"></div>
</div>

<script>
const BACKEND_URL='https://YOUR_VERCEL_APP/api/saveOrder';
let orders=[];

async function login(){
  const code=document.getElementById('loginCode').value.trim();
  if(!code) return alert('Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
  try{
    const res=await fetch('https://YOUR_VERCEL_APP/api/login',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({code})
    });
    const data=await res.json();
    if(data.ok){
      document.getElementById('loginDiv').classList.add('hidden');
      document.getElementById('mainDiv').classList.remove('hidden');
      loadOrders();
    }else alert('Ú©Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
  }catch(e){alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');}
}

async function loadOrders(){
  try{
    const res=await fetch(BACKEND_URL);
    if(res.ok){orders=await res.json();localStorage.setItem('orders',JSON.stringify(orders));return;}
  }catch{}
  orders=JSON.parse(localStorage.getItem('orders')||"[]");
}

function addField(type){
  let section=document.getElementById(type+'Section'); let html='';
  if(type==='paint') html=`<div class='paint-item'><input placeholder='Ø±Ù†Ú¯ Ú©Ø§Ø±' class='paintColor'></div>`;
  if(type==='fab') html=`<div class='fab-item'><input placeholder='Ú©Ø¯/Ø±Ù†Ú¯ Ù¾Ø§Ø±Ú†Ù‡' class='fabColor'></div>`;
  if(type==='carp') html=`<div class='carp-item'><input placeholder='Ù…Ø¯Ù„ Ù…Ø¨Ù„' class='carpModel'></div>`;
  if(type==='up') html=`<div class='up-item'><input placeholder='ØªÙˆØ¶ÛŒØ­Ø§Øª' class='upNote'></div>`;
  section.insertAdjacentHTML('beforeend',html);
}

function collect(selector,field){return [...document.querySelectorAll(selector)].map(el=>el.querySelector('input.'+field)?.value.trim()).filter(Boolean);}
function val(id){return document.getElementById(id).value.trim();}

async function saveOrder(){
  let order={
    invoiceNo:val('invoiceNo'),
    customer:val('customer'),
    model:val('model'),
    delDate:val('delDate'),
    delNote:val('delNote'),
    paint:collect('.paint-item','paintColor'),
    fab:collect('.fab-item','fabColor'),
    carp:collect('.carp-item','carpModel'),
    up:collect('.up-item','upNote')
  };
  orders.push(order);
  localStorage.setItem('orders',JSON.stringify(orders));
  clearForm();
  await pushToGithub(order);
  renderOrders();
  alert('âœ… Ø³ÙØ§Ø±Ø´ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
}

function clearForm(){document.querySelectorAll('input,textarea').forEach(el=>{if(el.type!=='file')el.value='';});document.getElementById('invoiceNo').focus();}
function toggleOrders(){document.getElementById('orderList').classList.toggle('hidden');renderOrders();}
function formatArray(arr){return arr.join('<br>');}

function renderOrders(){
  let listDiv=document.getElementById('orderList');
  let search=document.getElementById('searchInput').value.toLowerCase();
  let filtered=orders.filter(o=>o.invoiceNo.toLowerCase().includes(search) || o.customer.toLowerCase().includes(search) || o.model.toLowerCase().includes(search));
  if(filtered.length===0){listDiv.innerHTML='<p>Ù‡ÛŒÚ† Ø³ÙØ§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';return;}
  listDiv.innerHTML=filtered.map((o,i)=>`
  <div style='border:1px solid #000;padding:8px;margin-bottom:8px;'>
  <b>#${o.invoiceNo} | ${o.customer}</b> | Ù…Ø¯Ù„: ${o.model} | ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„: ${o.delDate}
  <div style='margin-top:6px;'>
  <button class='btn' onclick="showSection(${i},'paint')">ğŸ¨ Ø±Ù†Ú¯â€ŒÚ©Ø§Ø±ÛŒ</button>
  <button class='btn' onclick="showSection(${i},'fab')">ğŸ§µ Ø®ÛŒØ§Ø·ÛŒ</button>
  <button class='btn' onclick="showSection(${i},'carp')">ğŸª“ Ù†Ø¬Ø§Ø±ÛŒ</button>
  <button class='btn' onclick="showSection(${i},'up')">ğŸ›  Ø±ÙˆÛŒâ€ŒÚ©ÙˆØ¨ÛŒ</button>
  <button class='btn' onclick="showSection(${i},'del')">ğŸšš ØªØ­ÙˆÛŒÙ„ Ú©Ø§Ù„Ø§</button>
  </div></div>`).join('');
}

function showSection(i,type){
  const o=orders[i];let html='';
  if(type==='paint') html=`<h3>Ø±Ù†Ú¯â€ŒÚ©Ø§Ø±ÛŒ</h3>${formatArray(o.paint)}`;
  if(type==='fab') html=`<h3>Ø®ÛŒØ§Ø·ÛŒ</h3>${formatArray(o.fab)}`;
  if(type==='carp') html=`<h3>Ù†Ø¬Ø§Ø±ÛŒ</h3>${formatArray(o.carp)}`;
  if(type==='up') html=`<h3>Ø±ÙˆÛŒâ€ŒÚ©ÙˆØ¨ÛŒ</h3>${formatArray(o.up)}`;
  if(type==='del') html=`<h3>ØªØ­ÙˆÛŒÙ„ Ú©Ø§Ù„Ø§</h3>
  <b>Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±:</b> ${o.invoiceNo}<br>
  <b>Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ:</b> ${o.customer}<br>
  <b>Ù…Ø¯Ù„:</b> ${o.model}<br>
  <b>ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„:</b> ${o.delDate}<br>
  <b>Ø±Ù†Ú¯â€ŒÚ©Ø§Ø±ÛŒ:</b> ${formatArray(o.paint)}<br>
  <b>Ø®ÛŒØ§Ø·ÛŒ:</b> ${formatArray(o.fab)}<br>
  <b>Ù†Ø¬Ø§Ø±ÛŒ:</b> ${formatArray(o.carp)}<br>
  <b>Ø±ÙˆÛŒâ€ŒÚ©ÙˆØ¨ÛŒ:</b> ${formatArray(o.up)}<br>
  <b>ØªÙˆØ¶ÛŒØ­Ø§Øª ØªØ­ÙˆÛŒÙ„:</b> ${o.delNote}<br>`;
  const out=document.getElementById('output');
  out.innerHTML=`${html}<div style='text-align:center;margin-top:8px;'><button class='btn' onclick='printSection()'>ğŸ–¨ Ú†Ø§Ù¾</button></div>`;
  out.style.display='block';window.scrollTo(0,document.body.scrollHeight);
}

function printSection(){const content=document.getElementById('output').innerHTML;const newWin=window.open('','_blank');newWin.document.write('<html><head><title>Ú†Ø§Ù¾</title></head><body>'+content+'</body></html>');newWin.document.close();newWin.print();}

async function pushToGithub(order){
  try{
    const res=await fetch(BACKEND_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(order)});
    const data=await res.json();
    if(data.ok){orders=data.orders; localStorage.setItem('orders',JSON.stringify(orders)); renderOrders(); return true;}
    else return false;
  }catch(e){console.warn('pushToGithub failed',e); return false;}
}
</script>
</body>
</html>
